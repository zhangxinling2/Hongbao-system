### 业务概述与系统建模

#### 业务场景

礼包，庆祝，营销等

用例：发红包，收(抢)红包

#### 业务定义

##### 红包：一定数量和金额的红包序列

+ 红包是具有虚拟资金特征的商品
+ 发红包和收红包实际上是资金交易过程
+ 资金交易就是资金从一个账户流通到另一个账户的过程

那么发红包就是发红包的人向红包商购买红包，并支付金额，之后发布商品。收红包类似商品秒杀活动，区别就是不需要支付价格。

所以红包就可以定义成一个小而美的商品交易系统。

#### 红包业务模型

![image-20230822090825025](C:\Users\Administrator\OneDrive\图片\go笔记\红包业务.png)

#### 数据库物理模型设计

![image-20230822092906093](C:\Users\Administrator\OneDrive\图片\go笔记\资金账户数据库表.png)

这是对业务模型推导优化最后产出的物理模型，用户和账户是实体对象，账户流水是事务性数据。对账户模型来说，用户模型是在账户模型中的一个子集，体现在账户中的就是用户ID和用户名称。把用户模型和账户模型集成在一起，这样要查询用户信息时可以减少一次查询。最终产生两张表，账户表和账户流水表。

##### 从业务模型推到数据库物理模型

+ 可以一致可以不一致
+ 不能违背业务模型逻辑的前提下可以做一些优化
+ 冗余，合并，拆分，异构

![image-20230822105527253](C:\Users\Administrator\OneDrive\图片\go笔记\账户表和流水表.png)

##### 红包数据库物理模型的设计

![image-20230822112617950](C:\Users\Administrator\OneDrive\图片\go笔记\红包业务模型.png)

根据业务模型来看，商品，订单，库存，活动这四个模型都是一对一的关系，商品，库存，订单间是通过红包ID来关联，订单和订单详情之间是通过订单ID来关联。发红包时只使用，商品，订单，库存，活动这四个模型。订单和订单详情间是一对多的关系，通过订单ID关联，收红包只和订单，库存两个模型相关。



最后发现活动ID和订单ID是多余的，可以使用红包ID来表示。

![image-20230824143124268](C:\Users\Administrator\OneDrive\图片\go笔记\合并的红包物理模型.png)

### 架构设计

+ 用户接口层：用来向外暴露API
+ 应用服务接口层：用来协调业务，不负责业务逻辑，

### 基础设计和编码

#### 使用枚举

使用iota，有状态或需要持久化就不能使用iota。在启动后，只存在与内存，不参与进程间交互。

#### 使用json

marshal和unmarshal。推荐库：jsoniter

使用var json = jsoniter.ConfigCompatibleWithStandardLibrary替换为此库

#### 基础设施层

##### 配置设计

###### 配置文件

推荐等级：ini， properties yaml toml xml json(最好不要)

静态配置选择yaml或xml

动态配置采用ini或properties

程序级别的配置文件可以不分组，如boot.ini,config.ini

应用程序级别：app-mysql.properties



使用prop配置客户端工具库加持+ini格式。

go get -u github.com/tietang/props    安装props